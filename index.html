<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowCrypt - Pixel Art Dark Fantasy</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        :root {
            --dark-bg: #0a0a0f;
            --darker-bg: #050508;
            --accent-red: #8b0000;
            --accent-gold: #daa520;
            --accent-silver: #c0c0c0;
            --text-light: #e8e8e8;
            --text-dim: #a0a0a0;
            --border-dark: #1a1a2e;
            --border-light: #2d2d4d;
            
            --common: #969696;
            --uncommon: #2ecc71;
            --rare: #3498db;
            --epic: #9b59b6;
            --legendary: #f1c40f;
            
            --pixel-size: 2px;
            --border-pixel: 2px solid;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background: #0a0a0f;
            color: var(--text-light);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-container {
            position: relative;
            width: 1200px;
            height: 700px;
            display: flex;
            background: var(--darker-bg);
            border: var(--border-pixel) var(--accent-red);
            overflow: hidden;
        }

        .game-area {
            flex: 3;
            position: relative;
            overflow: hidden;
            background: #0a0a0f;
        }

        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* UI */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .health-bar, .mana-bar {
            position: absolute;
            left: 20px;
            background: #000;
            border: var(--border-pixel) #400;
            overflow: hidden;
        }

        .health-bar {
            top: 20px;
            width: 200px;
            height: 16px;
        }

        .mana-bar {
            top: 45px;
            width: 200px;
            height: 12px;
            border-color: #006;
        }

        .health-fill, .mana-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .health-fill { background: #8b0000; }
        .mana-fill { background: #1e90ff; }

        .player-stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 12px;
            border: var(--border-pixel) var(--border-light);
            font-size: 8px;
        }

        .stat-value {
            color: var(--accent-gold);
        }

        .floor-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 12px;
            border: var(--border-pixel) var(--border-light);
            font-size: 8px;
        }

        /* Mini Map */
        .mini-map {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.9);
            border: var(--border-pixel) var(--accent-gold);
            padding: 5px;
        }

        .mini-map-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 1px;
            width: 100%;
            height: 100%;
        }

        .mini-map-room {
            background: #2a2a3a;
            border: 1px solid #444;
            font-size: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .mini-map-room.current { background: #8b0000; }
        .mini-map-room.visited { background: #4a4a6a; }
        .mini-map-room.stairs { background: #daa520; }
        .mini-map-room.merchant { background: #32cd32; }
        .mini-map-room.boss { background: #dc143c; }

        /* Sidebar */
        .sidebar {
            flex: 1;
            background: rgba(10, 10, 20, 0.95);
            border-left: var(--border-pixel) var(--border-dark);
            padding: 10px;
            overflow-y: auto;
        }

        .inventory, .skills, .quest-log, .equipment {
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: var(--border-pixel) var(--border-dark);
            padding: 10px;
        }

        .section-title {
            color: var(--accent-gold);
            border-bottom: var(--border-pixel) var(--border-light);
            padding-bottom: 5px;
            margin-bottom: 8px;
            font-size: 10px;
            text-align: center;
        }

        .inventory-slots {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        .inventory-slot {
            width: 40px;
            height: 40px;
            background: #2a2a3a;
            border: var(--border-pixel) var(--border-light);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            cursor: pointer;
            position: relative;
        }

        .inventory-slot:hover::after {
            content: 'X';
            position: absolute;
            top: -5px;
            right: -5px;
            background: #8b0000;
            color: white;
            width: 12px;
            height: 12px;
            font-size: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid white;
        }

        .equipment-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }

        .equipment-slot {
            background: #2a2a3a;
            border: var(--border-pixel) var(--border-light);
            padding: 5px;
            text-align: center;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 8px;
        }

        /* Screens */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(10, 10, 15, 0.95);
            z-index: 100;
        }

        .title {
            font-size: 24px;
            color: var(--accent-gold);
            margin-bottom: 20px;
            text-align: center;
        }

        .subtitle {
            font-size: 10px;
            color: var(--text-dim);
            margin-bottom: 30px;
            text-align: center;
            max-width: 600px;
            line-height: 1.5;
        }

        .btn {
            background: #2a2a3a;
            color: var(--text-light);
            border: var(--border-pixel) var(--border-light);
            padding: 10px 20px;
            margin: 5px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
        }

        .btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .btn-primary {
            background: #8b0000;
            border-color: var(--accent-red);
        }

        /* Doors */
        .door {
            position: absolute;
            background: #8b0000;
            border: var(--border-pixel) var(--accent-gold);
            cursor: pointer;
            pointer-events: auto;
            z-index: 5;
        }

        .door.top, .door.bottom {
            width: 80px;
            height: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .door.top { top: 30px; }
        .door.bottom { bottom: 30px; }

        .door.left, .door.right {
            width: 20px;
            height: 80px;
            top: 50%;
            transform: translateY(-50%);
        }

        .door.left { left: 30px; }
        .door.right { right: 30px; }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a2e;
        }

        ::-webkit-scrollbar-thumb {
            background: #8b0000;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-area">
            <canvas id="game-canvas" width="900" height="700"></canvas>
            
            <!-- Doors -->
            <div class="door top" id="door-top" data-direction="top"></div>
            <div class="door bottom" id="door-bottom" data-direction="bottom"></div>
            <div class="door left" id="door-left" data-direction="left"></div>
            <div class="door right" id="door-right" data-direction="right"></div>
            
            <div class="ui-overlay">
                <div class="health-bar">
                    <div class="health-fill" id="health-fill"></div>
                </div>
                <div class="mana-bar">
                    <div class="mana-fill" id="mana-fill"></div>
                </div>
                
                <div class="player-stats">
                    <div>NVL: <span class="stat-value" id="player-level">1</span></div>
                    <div>DMG: <span class="stat-value" id="player-damage">10-15</span></div>
                    <div>DEF: <span class="stat-value" id="player-defense">5</span></div>
                    <div>GOLD: <span class="stat-value" id="player-gold">0</span></div>
                </div>
                
                <div class="floor-indicator">
                    FLOOR: <span id="floor-number">1</span> ROOM: <span id="room-number">1</span>
                </div>
                
                <div class="mini-map">
                    <div class="mini-map-grid" id="mini-map"></div>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="equipment">
                <div class="section-title">EQUIP</div>
                <div class="equipment-slots">
                    <div class="equipment-slot" data-slot="weapon">
                        <div>WEAPON</div>
                        <div id="equipped-weapon">-</div>
                    </div>
                    <div class="equipment-slot" data-slot="armor">
                        <div>ARMOR</div>
                        <div id="equipped-armor">-</div>
                    </div>
                    <div class="equipment-slot" data-slot="helmet">
                        <div>HELMET</div>
                        <div id="equipped-helmet">-</div>
                    </div>
                    <div class="equipment-slot" data-slot="boots">
                        <div>BOOTS</div>
                        <div id="equipped-boots">-</div>
                    </div>
                    <div class="equipment-slot" data-slot="ring">
                        <div>RING</div>
                        <div id="equipped-ring">-</div>
                    </div>
                    <div class="equipment-slot" data-slot="amulet">
                        <div>AMULET</div>
                        <div id="equipped-amulet">-</div>
                    </div>
                </div>
            </div>
            
            <div class="inventory">
                <div class="section-title">INVENTORY</div>
                <div class="inventory-slots" id="inventory-slots"></div>
            </div>
        </div>
        
        <!-- Start Screen -->
        <div class="screen start-screen">
            <div class="title">SHADOWCRYPT</div>
            <div class="subtitle">A PIXEL ART DARK FANTASY DUNGEON CRAWLER</div>
            <button class="btn btn-primary" id="start-btn">START QUEST</button>
        </div>
        
        <!-- Game Over Screen -->
        <div class="screen game-over" style="display: none;">
            <div class="title">GAME OVER</div>
            <div class="subtitle">YOUR JOURNEY ENDS IN THE DEPTHS...</div>
            <div id="game-over-stats" style="margin-bottom: 20px; text-align: center; font-size: 8px;"></div>
            <button class="btn btn-primary" id="restart-btn">TRY AGAIN</button>
        </div>
    </div>

    <script>
        // =============================================
        // PIXEL ART GAME ENGINE - MELHORADO
        // =============================================
        
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        // Game state
        let gameState = 'menu';
        let player = {};
        let currentFloor = 1;
        let currentRoom = 13;
        let rooms = [];
        let enemies = [];
        let items = [];
        let projectiles = [];
        let particles = [];
        let combatTexts = [];
        let roomCleared = false;
        let visitedRooms = new Set();
        let stairsLocation = null;
        let merchantRoom = null;
        let npcs = [];

        // Sprites detalhados 8x8 pixels
        const sprites = {
            // Player com diferentes sprites para direções
            player: {
                down: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,2,2,2,1,0],
                    [0,1,2,3,3,2,1,0],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,1,1,1,0,0],
                    [0,1,0,1,1,0,1,0],
                    [0,1,0,1,1,0,1,0],
                    [0,0,1,0,0,1,0,0]
                ],
                up: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,3,3,2,1,0],
                    [0,1,2,2,2,2,1,0],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,1,1,1,0,0],
                    [0,1,0,1,1,0,1,0],
                    [0,1,0,1,1,0,1,0],
                    [0,0,1,0,0,1,0,0]
                ],
                left: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,2,2,2,1,0],
                    [1,2,3,2,2,2,1,0],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,1,1,1,0,0],
                    [0,1,0,1,1,0,0,0],
                    [0,1,0,1,1,0,0,0],
                    [0,0,1,0,0,1,0,0]
                ],
                right: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,2,2,2,1,0],
                    [0,1,2,2,2,3,2,1],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,1,1,1,0,0],
                    [0,0,0,1,1,0,1,0],
                    [0,0,0,1,1,0,1,0],
                    [0,0,1,0,0,1,0,0]
                ],
                colors: ['#000000', '#4a4a6a', '#6a6a8a', '#8a8aaa']
            },

            // Inimigos detalhados
            skeleton: {
                body: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,2,2,2,1,0],
                    [0,1,2,3,3,2,1,0],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,1,1,1,0,0],
                    [0,0,1,0,0,1,0,0],
                    [0,1,0,1,1,0,1,0],
                    [1,0,0,0,0,0,0,1]
                ],
                colors: ['#000000', '#c0c0c0', '#ffffff', '#2a2a2a']
            },

            zombie: {
                body: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,2,2,2,1,0],
                    [0,1,2,3,3,2,1,0],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,1,1,1,0,0],
                    [0,1,0,1,1,0,1,0],
                    [1,0,1,0,0,1,0,1],
                    [0,1,0,0,0,0,1,0]
                ],
                colors: ['#000000', '#2d5a27', '#3d6a37', '#1a3a17']
            },

            ghost: {
                body: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,2,2,2,1,0],
                    [1,2,3,2,2,3,2,1],
                    [1,2,2,2,2,2,2,1],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,2,2,1,0,0],
                    [0,0,0,1,1,0,0,0],
                    [0,0,0,0,0,0,0,0]
                ],
                colors: ['#000000', '#7b68ee', '#9b88ff', '#5b48cc']
            },

            mimic: {
                body: [
                    [1,1,1,1,1,1,1,1],
                    [1,2,2,3,3,2,2,1],
                    [1,2,3,2,2,3,2,1],
                    [1,2,2,2,2,2,2,1],
                    [1,2,2,2,2,2,2,1],
                    [1,2,2,2,2,2,2,1],
                    [1,2,2,2,2,2,2,1],
                    [1,1,1,1,1,1,1,1]
                ],
                colors: ['#000000', '#8b0000', '#daa520', '#ff0000']
            },

            // NPCs
            merchant: {
                body: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,2,2,2,1,0],
                    [0,1,2,3,3,2,1,0],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,1,1,1,0,0],
                    [0,1,4,1,1,4,1,0],
                    [0,1,1,4,4,1,1,0],
                    [0,0,1,1,1,1,0,0]
                ],
                colors: ['#000000', '#32cd32', '#52ed52', '#12ad12', '#daa520']
            },

            stairs: {
                body: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,2,2,2,1,0],
                    [0,1,2,3,3,2,1,0],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,1,1,1,0,0],
                    [0,0,0,1,1,0,0,0],
                    [0,0,0,1,1,0,0,0],
                    [0,0,0,0,0,0,0,0]
                ],
                colors: ['#000000', '#daa520', '#fad560', '#ba8520']
            }
        };

        // Efeitos de ataque
        const attackEffects = {
            sword: [
                [0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0],
                [0,0,0,1,1,0,0,0],
                [0,0,1,2,2,1,0,0],
                [0,1,2,3,3,2,1,0],
                [0,0,1,2,2,1,0,0],
                [0,0,0,1,1,0,0,0],
                [0,0,0,0,0,0,0,0]
            ],
            bow: [
                [0,0,0,1,0,0,0,0],
                [0,0,0,0,1,0,0,0],
                [0,0,0,0,0,1,0,0],
                [1,0,0,0,0,0,1,0],
                [0,1,0,0,0,0,0,1],
                [0,0,1,0,0,0,0,0],
                [0,0,0,1,0,0,0,0],
                [0,0,0,0,1,0,0,0]
            ],
            staff: [
                [0,0,0,1,1,0,0,0],
                [0,0,1,2,2,1,0,0],
                [0,1,2,3,3,2,1,0],
                [1,2,3,4,4,3,2,1],
                [1,2,3,4,4,3,2,1],
                [0,1,2,3,3,2,1,0],
                [0,0,1,2,2,1,0,0],
                [0,0,0,1,1,0,0,0]
            ]
        };

        // Desenhar sprite 8x8
        function drawSprite(sprite, x, y, size = 32) {
            const pixelSize = size / 8;
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const colorIndex = sprite[row][col];
                    if (colorIndex > 0) {
                        ctx.fillStyle = sprite.colors[colorIndex];
                        ctx.fillRect(
                            x + col * pixelSize - size/2,
                            y + row * pixelSize - size/2,
                            pixelSize,
                            pixelSize
                        );
                    }
                }
            }
        }

        // Desenhar efeito de ataque
        function drawAttackEffect(type, x, y, angle, size = 32) {
            const effect = attackEffects[type];
            if (!effect) return;
            
            const pixelSize = size / 8;
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const colorIndex = effect[row][col];
                    if (colorIndex > 0) {
                        let color;
                        switch(type) {
                            case 'sword': color = ['#000000', '#c0c0c0', '#daa520', '#ff4500'][colorIndex-1]; break;
                            case 'bow': color = ['#000000', '#8b4513', '#daa520'][colorIndex-1]; break;
                            case 'staff': color = ['#000000', '#9370db', '#1e90ff', '#ff69b4'][colorIndex-1]; break;
                        }
                        ctx.fillStyle = color;
                        ctx.fillRect(
                            (col - 4) * pixelSize,
                            (row - 4) * pixelSize,
                            pixelSize,
                            pixelSize
                        );
                    }
                }
            }
            ctx.restore();
        }

        // Tipos de armas com skins
        const weaponTypes = [
            { 
                name: 'Short Sword', 
                damage: [8, 12], 
                rarity: 'common', 
                type: 'weapon', 
                slot: 'weapon',
                attackType: 'sword',
                skin: [
                    [0,0,0,1,1,0,0,0],
                    [0,0,0,1,1,0,0,0],
                    [0,0,0,1,1,0,0,0],
                    [0,0,1,2,2,1,0,0],
                    [0,1,2,3,3,2,1,0],
                    [0,0,1,2,2,1,0,0],
                    [0,0,0,1,1,0,0,0],
                    [0,0,0,1,1,0,0,0]
                ],
                skinColors: ['#000000', '#c0c0c0', '#8a8aaa', '#6a6a8a']
            },
            { 
                name: 'Long Bow', 
                damage: [6, 10], 
                rarity: 'uncommon', 
                type: 'weapon', 
                slot: 'weapon',
                attackType: 'bow',
                skin: [
                    [0,0,0,0,1,1,0,0],
                    [0,0,0,1,2,2,1,0],
                    [0,0,1,2,2,2,2,1],
                    [0,0,0,1,2,2,1,0],
                    [0,0,0,1,2,2,1,0],
                    [0,0,1,2,2,2,2,1],
                    [0,0,0,1,2,2,1,0],
                    [0,0,0,0,1,1,0,0]
                ],
                skinColors: ['#000000', '#8b4513', '#daa520']
            },
            { 
                name: 'Magic Staff', 
                damage: [5, 8], 
                rarity: 'rare', 
                type: 'weapon', 
                slot: 'weapon',
                attackType: 'staff',
                manaCost: 5,
                skin: [
                    [0,0,0,1,1,0,0,0],
                    [0,0,0,1,1,0,0,0],
                    [0,0,0,1,1,0,0,0],
                    [0,0,1,2,2,1,0,0],
                    [0,1,2,3,3,2,1,0],
                    [0,0,1,2,2,1,0,0],
                    [0,0,0,1,1,0,0,0],
                    [0,0,1,3,3,1,0,0]
                ],
                skinColors: ['#000000', '#8b4513', '#9370db', '#ff69b4']
            }
        ];

        // Input handling
        const keys = {};
        const mouse = { x: 0, y: 0, down: false };
        
        // Game engine
        const game = {
            loop: function() {
                if (gameState !== 'playing') return;
                
                this.update();
                this.render();
                requestAnimationFrame(() => this.loop());
            },
            
            update: function() {
                this.updatePlayer();
                this.updateEnemies();
                this.updateProjectiles();
                this.updateParticles();
                this.updateCombatTexts();
                this.updateNPCs();
                this.checkCollisions();
                this.updateUI();
                this.updateDoors();
                this.updateMiniMap();
            },

            updateDoors: function() {
                const directions = ['top', 'bottom', 'left', 'right'];
                directions.forEach(direction => {
                    const door = document.getElementById(`door-${direction}`);
                    if (this.hasDoor(direction)) {
                        door.style.display = 'block';
                    } else {
                        door.style.display = 'none';
                    }
                });
            },

            hasDoor: function(direction) {
                if (!rooms[currentRoom] || !rooms[currentRoom].doors) return false;
                return rooms[currentRoom].doors[direction];
            },

            changeRoom: function(direction) {
                let newRoom = currentRoom;
                switch(direction) {
                    case 'top': newRoom -= 5; break;
                    case 'bottom': newRoom += 5; break;
                    case 'left': newRoom -= 1; break;
                    case 'right': newRoom += 1; break;
                }

                if (newRoom >= 1 && newRoom <= 25) {
                    currentRoom = newRoom;
                    visitedRooms.add(currentRoom);
                    this.generateRoom();
                    this.positionPlayerFromDoor(direction);
                }
            },

            positionPlayerFromDoor: function(direction) {
                switch(direction) {
                    case 'top': player.y = canvas.height - 60; break;
                    case 'bottom': player.y = 60; break;
                    case 'left': player.x = canvas.width - 60; break;
                    case 'right': player.x = 60; break;
                }
            },

            updateMiniMap: function() {
                const miniMap = document.getElementById('mini-map');
                miniMap.innerHTML = '';
                
                for (let row = 0; row < 5; row++) {
                    for (let col = 0; col < 5; col++) {
                        const roomNumber = row * 5 + col + 1;
                        const roomElement = document.createElement('div');
                        roomElement.className = 'mini-map-room';
                        
                        if (roomNumber === currentRoom) {
                            roomElement.classList.add('current');
                            roomElement.textContent = '●';
                        } else if (visitedRooms.has(roomNumber)) {
                            roomElement.classList.add('visited');
                            roomElement.textContent = '▪';
                        }
                        
                        miniMap.appendChild(roomElement);
                    }
                }
            },

            updateNPCs: function() {
                npcs.forEach(npc => {
                    if (npc.type === 'merchant') {
                        // Merchant idle animation
                        npc.animationTimer = (npc.animationTimer || 0) + 1;
                        if (npc.animationTimer > 60) {
                            npc.animationTimer = 0;
                            npc.frame = (npc.frame || 0) + 1;
                        }
                    }
                });
            },
            
            render: function() {
                ctx.fillStyle = '#0a0a0f';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                this.drawRoom();
                
                // Draw NPCs
                npcs.forEach(npc => {
                    drawSprite(sprites[npc.type], npc.x, npc.y, 32);
                });
                
                // Draw items
                items.forEach(item => {
                    if (item.type === 'chest' || item.type === 'mimic') {
                        drawSprite(sprites[item.type], item.x, item.y, 32);
                    } else if (item.skin) {
                        // Draw weapon with custom skin
                        ctx.save();
                        ctx.translate(item.x, item.y);
                        ctx.rotate(Math.PI / 4); // Rotate 45 degrees for better display
                        drawSprite({...item.skin, colors: item.skinColors}, 0, 0, 24);
                        ctx.restore();
                    } else {
                        ctx.fillStyle = item.color;
                        ctx.fillRect(item.x - 6, item.y - 6, 12, 12);
                    }
                });
                
                // Draw enemies
                enemies.forEach(enemy => {
                    drawSprite(sprites[enemy.type], enemy.x, enemy.y, 32);
                });
                
                // Draw player with direction
                const direction = this.getPlayerDirection();
                drawSprite({...sprites.player[direction], colors: sprites.player.colors}, player.x, player.y, 32);
                
                // Draw equipped weapon skin near player
                if (player.equippedWeapon && player.equippedWeapon.skin) {
                    ctx.save();
                    ctx.translate(player.x + 20, player.y - 20);
                    drawSprite(
                        {...player.equippedWeapon.skin, colors: player.equippedWeapon.skinColors}, 
                        0, 0, 20
                    );
                    ctx.restore();
                }
                
                // Draw projectiles
                projectiles.forEach(projectile => {
                    if (projectile.effect) {
                        drawAttackEffect(projectile.effect, projectile.x, projectile.y, projectile.angle, 24);
                    } else {
                        ctx.fillStyle = projectile.color;
                        ctx.fillRect(projectile.x - 3, projectile.y - 3, 6, 6);
                    }
                });

                // Draw attack effect if attacking
                if (player.attacking && player.attackTimer > 0) {
                    const weaponType = player.equippedWeapon ? player.equippedWeapon.attackType : 'sword';
                    drawAttackEffect(weaponType, player.attackX, player.attackY, player.angle, 40);
                    player.attackTimer--;
                }
            },

            getPlayerDirection: function() {
                const angle = player.angle;
                if (angle >= -Math.PI/4 && angle < Math.PI/4) return 'right';
                if (angle >= Math.PI/4 && angle < 3*Math.PI/4) return 'down';
                if (angle >= -3*Math.PI/4 && angle < -Math.PI/4) return 'up';
                return 'left';
            },
            
            drawRoom: function() {
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(50, 50, canvas.width - 100, canvas.height - 100);
                
                ctx.strokeStyle = '#2d2d4d';
                ctx.lineWidth = 4;
                ctx.strokeRect(50, 50, canvas.width - 100, canvas.height - 100);
                
                // Draw detailed pixel torches
                ctx.fillStyle = '#8b0000';
                this.drawTorch(70, 70);
                this.drawTorch(canvas.width - 70, 70);
                this.drawTorch(70, canvas.height - 70);
                this.drawTorch(canvas.width - 70, canvas.height - 70);
            },

            drawTorch: function(x, y) {
                // Base
                ctx.fillStyle = '#2a2a2a';
                ctx.fillRect(x-2, y-2, 4, 8);
                
                // Flame
                ctx.fillStyle = '#8b0000';
                ctx.fillRect(x-1, y-4, 2, 3);
                ctx.fillStyle = '#daa520';
                ctx.fillRect(x-1, y-5, 2, 2);
            },
            
            updatePlayer: function() {
                let moveX = 0, moveY = 0;
                
                if (keys['w'] || keys['ArrowUp']) moveY -= player.speed;
                if (keys['s'] || keys['ArrowDown']) moveY += player.speed;
                if (keys['a'] || keys['ArrowLeft']) moveX -= player.speed;
                if (keys['d'] || keys['ArrowRight']) moveX += player.speed;
                
                player.x += moveX;
                player.y += moveY;
                
                player.x = Math.max(60, Math.min(canvas.width - 60, player.x));
                player.y = Math.max(60, Math.min(canvas.height - 60, player.y));
                
                const dx = mouse.x - player.x;
                const dy = mouse.y - player.y;
                player.angle = Math.atan2(dy, dx);
                
                if (mouse.down && player.attackCooldown <= 0) {
                    this.playerAttack();
                }
                
                if (player.attackCooldown > 0) {
                    player.attackCooldown--;
                }

                // Check for interactions
                if (keys['e']) {
                    this.checkInteractions();
                    keys['e'] = false;
                }
            },

            checkInteractions: function() {
                // Check stairs
                npcs.forEach(npc => {
                    if (npc.type === 'stairs') {
                        const dx = player.x - npc.x;
                        const dy = player.y - npc.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 40) {
                            this.nextFloor();
                            return;
                        }
                    }
                });
            },

            nextFloor: function() {
                currentFloor++;
                if (currentFloor > 5) {
                    alert('Congratulations! You completed all floors!');
                    this.gameOver();
                    return;
                }
                
                // Heal player
                player.health = player.maxHealth;
                player.mana = player.maxMana;
                
                // Generate new floor
                this.generateFloor();
                this.addCombatText(`Floor ${currentFloor}!`, player.x, player.y, '#00ff00');
            },
            
            playerAttack: function() {
                const weapon = player.equippedWeapon;
                const attackType = weapon ? weapon.attackType : 'sword';
                
                // Set attack animation
                player.attacking = true;
                player.attackTimer = 10;
                player.attackX = player.x + Math.cos(player.angle) * 25;
                player.attackY = player.y + Math.sin(player.angle) * 25;
                
                let projectile;
                
                switch(attackType) {
                    case 'sword':
                        // Melee attack - damage enemies in arc
                        const arcAngle = Math.PI / 3; // 60 degree arc
                        enemies.forEach(enemy => {
                            const dx = enemy.x - player.x;
                            const dy = enemy.y - player.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            const enemyAngle = Math.atan2(dy, dx);
                            const angleDiff = Math.abs(player.angle - enemyAngle);
                            
                            if (distance < 50 && angleDiff < arcAngle/2) {
                                enemy.health -= this.calculatePlayerDamage();
                            }
                        });
                        break;
                        
                    case 'bow':
                        // Ranged projectile
                        projectile = {
                            x: player.x,
                            y: player.y,
                            vx: Math.cos(player.angle) * 8,
                            vy: Math.sin(player.angle) * 8,
                            damage: this.calculatePlayerDamage(),
                            lifetime: 90,
                            effect: 'bow',
                            angle: player.angle
                        };
                        projectiles.push(projectile);
                        break;
                        
                    case 'staff':
                        // Magic projectile with mana cost
                        if (player.mana >= (weapon.manaCost || 5)) {
                            player.mana -= weapon.manaCost;
                            projectile = {
                                x: player.x,
                                y: player.y,
                                vx: Math.cos(player.angle) * 6,
                                vy: Math.sin(player.angle) * 6,
                                damage: this.calculatePlayerDamage(),
                                lifetime: 120,
                                effect: 'staff',
                                angle: player.angle
                            };
                            projectiles.push(projectile);
                        }
                        break;
                }
                
                player.attackCooldown = player.attackSpeed;
            },
            
            updateEnemies: function() {
                enemies.forEach((enemy, index) => {
                    if (enemy.health <= 0) {
                        if (Math.random() < 0.3) {
                            this.spawnLoot(enemy.x, enemy.y);
                        }
                        enemies.splice(index, 1);
                        return;
                    }
                    
                    const dx = player.x - enemy.x;
                    const dy = player.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 150) {
                        enemy.x += (dx / distance) * enemy.speed;
                        enemy.y += (dy / distance) * enemy.speed;
                    }
                });
            },
            
            updateProjectiles: function() {
                for (let i = projectiles.length - 1; i >= 0; i--) {
                    const projectile = projectiles[i];
                    projectile.x += projectile.vx;
                    projectile.y += projectile.vy;
                    projectile.lifetime--;
                    
                    if (projectile.lifetime <= 0) {
                        projectiles.splice(i, 1);
                    }
                }
            },
            
            updateParticles: function() {
                // Particle system
            },
            
            updateCombatTexts: function() {
                // Combat text system
            },

            addCombatText: function(text, x, y, color) {
                combatTexts.push({
                    text: text,
                    x: x,
                    y: y,
                    color: color,
                    life: 60
                });
            },
            
            checkCollisions: function() {
                // Projectile vs Enemy
                for (let i = projectiles.length - 1; i >= 0; i--) {
                    for (let j = enemies.length - 1; j >= 0; j--) {
                        const dx = projectiles[i].x - enemies[j].x;
                        const dy = projectiles[i].y - enemies[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 20) {
                            enemies[j].health -= projectiles[i].damage;
                            projectiles.splice(i, 1);
                            break;
                        }
                    }
                }
                
                // Player vs Items
                for (let i = items.length - 1; i >= 0; i--) {
                    const dx = player.x - items[i].x;
                    const dy = player.y - items[i].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 25) {
                        this.collectItem(items[i]);
                        items.splice(i, 1);
                    }
                }
            },
            
            collectItem: function(item) {
                if (item.type === 'chest') {
                    for (let i = 0; i < 3; i++) {
                        this.spawnRandomItem(item.x, item.y);
                    }
                } else if (item.type === 'mimic') {
                    enemies.push(this.createEnemy('mimic', item.x, item.y));
                } else {
                    this.addToInventory(item);
                }
            },
            
            spawnLoot: function(x, y) {
                const lootTypes = ['weapon', 'armor', 'helmet', 'boots', 'ring', 'amulet'];
                const lootType = lootTypes[Math.floor(Math.random() * lootTypes.length)];
                this.spawnRandomItem(x, y, lootType);
            },
            
            spawnRandomItem: function(x, y, type = null) {
                if (!type) {
                    const types = ['weapon', 'armor', 'helmet', 'boots', 'ring', 'amulet', 'chest', 'mimic'];
                    type = types[Math.floor(Math.random() * types.length)];
                }
                
                let item;
                const rarityRoll = Math.random();
                let rarityIndex = Math.floor(rarityRoll * weaponTypes.length);
                
                if (type === 'weapon') {
                    item = {...weaponTypes[rarityIndex]};
                } else {
                    // Placeholder for other item types
                    item = {
                        type: type,
                        name: type.charAt(0).toUpperCase() + type.slice(1),
                        x: x,
                        y: y,
                        color: '#daa520'
                    };
                }
                
                item.x = x;
                item.y = y;
                items.push(item);
            },
            
            createEnemy: function(type, x, y) {
                const enemy = {
                    type: type,
                    x: x || Math.random() * (canvas.width - 100) + 50,
                    y: y || Math.random() * (canvas.height - 100) + 50,
                    health: 30,
                    maxHealth: 30,
                    damage: 5,
                    speed: 1,
                    size: 20
                };
                return enemy;
            },

            generateFloor: function() {
                rooms = [];
                visitedRooms = new Set([13]);
                currentRoom = 13;
                
                // Generate random special rooms
                const specialRooms = this.generateSpecialRooms();
                stairsLocation = specialRooms.stairs;
                merchantRoom = specialRooms.merchant;
                
                // Create 5x5 grid
                for (let i = 1; i <= 25; i++) {
                    let roomType = 'normal';
                    if (i === 13) roomType = 'start';
                    else if (i === stairsLocation) roomType = 'stairs';
                    else if (i === merchantRoom) roomType = 'merchant';
                    
                    rooms[i] = {
                        type: roomType,
                        doors: this.generateDoors(i),
                        cleared: i === 13
                    };
                }
                
                this.generateRoom();
            },

            generateSpecialRooms: function() {
                const availableRooms = [];
                for (let i = 1; i <= 25; i++) {
                    if (i !== 13) availableRooms.push(i);
                }
                
                // Shuffle and pick special rooms
                this.shuffleArray(availableRooms);
                return {
                    stairs: availableRooms[0],
                    merchant: availableRooms[1]
                };
            },

            shuffleArray: function(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            },

            generateDoors: function(roomNumber) {
                const row = Math.floor((roomNumber - 1) / 5);
                const col = (roomNumber - 1) % 5;
                
                return {
                    top: row > 0,
                    bottom: row < 4,
                    left: col > 0,
                    right: col < 4
                };
            },

            generateRoom: function() {
                enemies = [];
                items = [];
                npcs = [];
                
                const room = rooms[currentRoom];
                
                // Add content based on room type
                switch(room.type) {
                    case 'start':
                        // Safe room
                        break;
                    case 'stairs':
                        npcs.push({
                            type: 'stairs',
                            x: canvas.width / 2,
                            y: canvas.height / 2
                        });
                        break;
                    case 'merchant':
                        npcs.push({
                            type: 'merchant',
                            x: canvas.width / 2,
                            y: canvas.height / 2
                        });
                        break;
                    default:
                        // Normal room with enemies
                        const enemyCount = 2 + Math.floor(Math.random() * 3);
                        for (let i = 0; i < enemyCount; i++) {
                            const enemyTypes = ['skeleton', 'zombie', 'ghost'];
                            const enemyType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                            enemies.push(this.createEnemy(enemyType));
                        }
                        
                        // Chance for chest
                        if (Math.random() < 0.4) {
                            items.push({
                                type: Math.random() < 0.2 ? 'mimic' : 'chest',
                                x: Math.random() * (canvas.width - 100) + 50,
                                y: Math.random() * (canvas.height - 100) + 50
                            });
                        }
                }
            },
            
            calculatePlayerDamage: function() {
                let damage = player.damageMin + Math.random() * (player.damageMax - player.damageMin);
                if (player.equippedWeapon) {
                    damage += player.equippedWeapon.damage[0] + 
                             Math.random() * (player.equippedWeapon.damage[1] - player.equippedWeapon.damage[0]);
                }
                return Math.floor(damage);
            },
            
            addToInventory: function(item) {
                if (player.inventory.length < 16) {
                    player.inventory.push(item);
                    this.updateInventoryUI();
                }
            },
            
            updateInventoryUI: function() {
                const inventorySlots = document.getElementById('inventory-slots');
                inventorySlots.innerHTML = '';
                
                player.inventory.forEach((item, index) => {
                    const slot = document.createElement('div');
                    slot.className = 'inventory-slot';
                    slot.textContent = item.name.charAt(0);
                    slot.title = `${item.name} (${item.rarity || 'common'})`;
                    
                    slot.addEventListener('click', (e) => {
                        if (e.altKey) {
                            player.inventory.splice(index, 1);
                            this.updateInventoryUI();
                        } else {
                            this.equipItem(index);
                        }
                    });
                    
                    inventorySlots.appendChild(slot);
                });
                
                for (let i = player.inventory.length; i < 16; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'inventory-slot';
                    inventorySlots.appendChild(slot);
                }
            },
            
            equipItem: function(index) {
                const item = player.inventory[index];
                const slotType = item.slot;
                
                if (player['equipped' + slotType.charAt(0).toUpperCase() + slotType.slice(1)]) {
                    player.inventory.push(player['equipped' + slotType.charAt(0).toUpperCase() + slotType.slice(1)]);
                }
                
                player['equipped' + slotType.charAt(0).toUpperCase() + slotType.slice(1)] = item;
                player.inventory.splice(index, 1);
                
                this.updatePlayerStats();
                this.updateInventoryUI();
                this.updateEquipmentUI();
            },
            
            updatePlayerStats: function() {
                player.defense = 5;
                player.speed = 4;
                
                if (player.equippedArmor) player.defense += player.equippedArmor.defense;
                if (player.equippedHelmet) player.defense += player.equippedHelmet.defense;
                if (player.equippedBoots) {
                    player.defense += (player.equippedBoots.defense || 0);
                    player.speed += (player.equippedBoots.speed || 0);
                }
                if (player.equippedRing) {
                    player.damageMin += player.equippedRing.damage[0];
                    player.damageMax += player.equippedRing.damage[1];
                }
                if (player.equippedAmulet) {
                    player.maxHealth += player.equippedAmulet.health;
                }

                // Update attack speed based on weapon type
                if (player.equippedWeapon) {
                    switch(player.equippedWeapon.attackType) {
                        case 'sword': player.attackSpeed = 25; break;
                        case 'bow': player.attackSpeed = 35; break;
                        case 'staff': player.attackSpeed = 30; break;
                    }
                } else {
                    player.attackSpeed = 30;
                }
            },
            
            updateEquipmentUI: function() {
                const slots = ['weapon', 'armor', 'helmet', 'boots', 'ring', 'amulet'];
                slots.forEach(slot => {
                    const equipped = player['equipped' + slot.charAt(0).toUpperCase() + slot.slice(1)];
                    document.getElementById('equipped-' + slot).textContent = equipped ? equipped.name : '-';
                });
            },
            
            updateUI: function() {
                document.getElementById('health-fill').style.width = (player.health / player.maxHealth * 100) + '%';
                document.getElementById('mana-fill').style.width = (player.mana / player.maxMana * 100) + '%';
                document.getElementById('player-level').textContent = player.level;
                document.getElementById('player-damage').textContent = player.damageMin + '-' + player.damageMax;
                document.getElementById('player-defense').textContent = player.defense;
                document.getElementById('player-gold').textContent = player.gold;
                document.getElementById('floor-number').textContent = currentFloor;
                document.getElementById('room-number').textContent = currentRoom;
            },

            gameOver: function() {
                gameState = 'gameOver';
                document.querySelector('.game-over').style.display = 'flex';
                document.getElementById('game-over-stats').innerHTML = `
                    <div>Reached Level: ${player.level}</div>
                    <div>Floor: ${currentFloor}</div>
                    <div>Gold: ${player.gold}</div>
                `;
            },
            
            initGame: function() {
                player = {
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    size: 20,
                    speed: 4,
                    health: 100,
                    maxHealth: 100,
                    mana: 100,
                    maxMana: 100,
                    damageMin: 8,
                    damageMax: 12,
                    defense: 5,
                    level: 1,
                    gold: 0,
                    attackCooldown: 0,
                    attackSpeed: 30,
                    attacking: false,
                    attackTimer: 0,
                    inventory: [],
                    equippedWeapon: null,
                    equippedArmor: null,
                    equippedHelmet: null,
                    equippedBoots: null,
                    equippedRing: null,
                    equippedAmulet: null
                };
                
                currentFloor = 1;
                currentRoom = 13;
                visitedRooms = new Set([13]);
                
                this.generateFloor();
                this.updateInventoryUI();
                this.updateEquipmentUI();
                this.loop();
            }
        };

        // Event Listeners
        window.addEventListener('load', function() {
            // Mouse events
            canvas.addEventListener('mousemove', function(e) {
                const rect = canvas.getBoundingClientRect();
                mouse.x = (e.clientX - rect.left) * (canvas.width / rect.width);
                mouse.y = (e.clientY - rect.top) * (canvas.height / rect.height);
            });
            
            canvas.addEventListener('mousedown', function() {
                mouse.down = true;
            });
            
            canvas.addEventListener('mouseup', function() {
                mouse.down = false;
            });
            
            // Keyboard events
            window.addEventListener('keydown', function(e) {
                keys[e.key] = true;
            });
            
            window.addEventListener('keyup', function(e) {
                keys[e.key] = false;
            });
            
            // Door events
            document.querySelectorAll('.door').forEach(door => {
                door.addEventListener('click', function() {
                    const direction = this.dataset.direction;
                    game.changeRoom(direction);
                });
            });
            
            // UI events
            document.getElementById('start-btn').addEventListener('click', function() {
                document.querySelector('.start-screen').style.display = 'none';
                gameState = 'playing';
                game.initGame();
            });
            
            document.getElementById('restart-btn').addEventListener('click', function() {
                document.querySelector('.game-over').style.display = 'none';
                gameState = 'playing';
                game.initGame();
            });
            
            // Create initial inventory slots
            const inventorySlots = document.getElementById('inventory-slots');
            for (let i = 0; i < 16; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                inventorySlots.appendChild(slot);
            }
        });
    </script>
</body>
</html>
