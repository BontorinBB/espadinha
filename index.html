<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowCrypt - Pixel Art Dark Fantasy</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        :root {
            --dark-bg: #0a0a0f;
            --darker-bg: #050508;
            --accent-red: #8b0000;
            --accent-gold: #daa520;
            --accent-silver: #c0c0c0;
            --text-light: #e8e8e8;
            --text-dim: #a0a0a0;
            --border-dark: #1a1a2e;
            --border-light: #2d2d4d;
            
            --common: #969696;
            --uncommon: #2ecc71;
            --rare: #3498db;
            --epic: #9b59b6;
            --legendary: #f1c40f;
            
            --pixel-size: 2px;
            --border-pixel: 2px solid;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background: #0a0a0f;
            color: var(--text-light);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-container {
            position: relative;
            width: 1200px;
            height: 700px;
            display: flex;
            background: var(--darker-bg);
            border: var(--border-pixel) var(--accent-red);
            overflow: hidden;
        }

        .game-area {
            flex: 3;
            position: relative;
            overflow: hidden;
            background: #0a0a0f;
        }

        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* UI */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .health-bar, .mana-bar {
            position: absolute;
            left: 20px;
            background: #000;
            border: var(--border-pixel) #400;
            overflow: hidden;
        }

        .health-bar {
            top: 20px;
            width: 200px;
            height: 16px;
        }

        .mana-bar {
            top: 45px;
            width: 200px;
            height: 12px;
            border-color: #006;
        }

        .health-fill, .mana-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .health-fill { background: #8b0000; }
        .mana-fill { background: #1e90ff; }

        .player-stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 12px;
            border: var(--border-pixel) var(--border-light);
            font-size: 8px;
        }

        .stat-value {
            color: var(--accent-gold);
        }

        .floor-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 12px;
            border: var(--border-pixel) var(--border-light);
            font-size: 8px;
        }

        /* Mini Map */
        .mini-map {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.9);
            border: var(--border-pixel) var(--accent-gold);
            padding: 5px;
        }

        .mini-map-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 1px;
            width: 100%;
            height: 100%;
        }

        .mini-map-room {
            background: #2a2a3a;
            border: 1px solid #444;
            font-size: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .mini-map-room.current { background: #8b0000; }
        .mini-map-room.visited { background: #4a4a6a; }
        .mini-map-room.stairs { background: #daa520; }
        .mini-map-room.merchant { background: #32cd32; }
        .mini-map-room.boss { background: #dc143c; }

        /* Sidebar */
        .sidebar {
            flex: 1;
            background: rgba(10, 10, 20, 0.95);
            border-left: var(--border-pixel) var(--border-dark);
            padding: 10px;
            overflow-y: auto;
        }

        .inventory, .skills, .quest-log, .equipment {
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: var(--border-pixel) var(--border-dark);
            padding: 10px;
        }

        .section-title {
            color: var(--accent-gold);
            border-bottom: var(--border-pixel) var(--border-light);
            padding-bottom: 5px;
            margin-bottom: 8px;
            font-size: 10px;
            text-align: center;
        }

        .inventory-slots {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        .inventory-slot {
            width: 40px;
            height: 40px;
            background: #2a2a3a;
            border: var(--border-pixel) var(--border-light);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            cursor: pointer;
            position: relative;
        }

        .inventory-slot:hover::after {
            content: 'X';
            position: absolute;
            top: -5px;
            right: -5px;
            background: #8b0000;
            color: white;
            width: 12px;
            height: 12px;
            font-size: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid white;
        }

        .equipment-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }

        .equipment-slot {
            background: #2a2a3a;
            border: var(--border-pixel) var(--border-light);
            padding: 5px;
            text-align: center;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 8px;
        }

        /* Screens */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(10, 10, 15, 0.95);
            z-index: 100;
        }

        .title {
            font-size: 24px;
            color: var(--accent-gold);
            margin-bottom: 20px;
            text-align: center;
        }

        .subtitle {
            font-size: 10px;
            color: var(--text-dim);
            margin-bottom: 30px;
            text-align: center;
            max-width: 600px;
            line-height: 1.5;
        }

        .btn {
            background: #2a2a3a;
            color: var(--text-light);
            border: var(--border-pixel) var(--border-light);
            padding: 10px 20px;
            margin: 5px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
        }

        .btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .btn-primary {
            background: #8b0000;
            border-color: var(--accent-red);
        }

        /* Doors */
        .door {
            position: absolute;
            background: #8b0000;
            border: var(--border-pixel) var(--accent-gold);
            cursor: pointer;
            pointer-events: auto;
            z-index: 5;
        }

        .door.top, .door.bottom {
            width: 80px;
            height: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .door.top { top: 30px; }
        .door.bottom { bottom: 30px; }

        .door.left, .door.right {
            width: 20px;
            height: 80px;
            top: 50%;
            transform: translateY(-50%);
        }

        .door.left { left: 30px; }
        .door.right { right: 30px; }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a2e;
        }

        ::-webkit-scrollbar-thumb {
            background: #8b0000;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-area">
            <canvas id="game-canvas" width="900" height="700"></canvas>
            
            <!-- Doors -->
            <div class="door top" id="door-top" data-direction="top"></div>
            <div class="door bottom" id="door-bottom" data-direction="bottom"></div>
            <div class="door left" id="door-left" data-direction="left"></div>
            <div class="door right" id="door-right" data-direction="right"></div>
            
            <div class="ui-overlay">
                <div class="health-bar">
                    <div class="health-fill" id="health-fill"></div>
                </div>
                <div class="mana-bar">
                    <div class="mana-fill" id="mana-fill"></div>
                </div>
                
                <div class="player-stats">
                    <div>NVL: <span class="stat-value" id="player-level">1</span></div>
                    <div>DMG: <span class="stat-value" id="player-damage">10-15</span></div>
                    <div>DEF: <span class="stat-value" id="player-defense">5</span></div>
                    <div>GOLD: <span class="stat-value" id="player-gold">0</span></div>
                </div>
                
                <div class="floor-indicator">
                    FLOOR: <span id="floor-number">1</span> ROOM: <span id="room-number">1</span>
                </div>
                
                <div class="mini-map">
                    <div class="mini-map-grid" id="mini-map"></div>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="equipment">
                <div class="section-title">EQUIP</div>
                <div class="equipment-slots">
                    <div class="equipment-slot" data-slot="weapon">
                        <div>WEAPON</div>
                        <div id="equipped-weapon">-</div>
                    </div>
                    <div class="equipment-slot" data-slot="armor">
                        <div>ARMOR</div>
                        <div id="equipped-armor">-</div>
                    </div>
                    <div class="equipment-slot" data-slot="helmet">
                        <div>HELMET</div>
                        <div id="equipped-helmet">-</div>
                    </div>
                    <div class="equipment-slot" data-slot="boots">
                        <div>BOOTS</div>
                        <div id="equipped-boots">-</div>
                    </div>
                    <div class="equipment-slot" data-slot="ring">
                        <div>RING</div>
                        <div id="equipped-ring">-</div>
                    </div>
                    <div class="equipment-slot" data-slot="amulet">
                        <div>AMULET</div>
                        <div id="equipped-amulet">-</div>
                    </div>
                </div>
            </div>
            
            <div class="inventory">
                <div class="section-title">INVENTORY</div>
                <div class="inventory-slots" id="inventory-slots"></div>
            </div>
        </div>
        
        <!-- Start Screen -->
        <div class="screen start-screen">
            <div class="title">SHADOWCRYPT</div>
            <div class="subtitle">A PIXEL ART DARK FANTASY DUNGEON CRAWLER</div>
            <button class="btn btn-primary" id="start-btn">START QUEST</button>
        </div>
        
        <!-- Game Over Screen -->
        <div class="screen game-over" style="display: none;">
            <div class="title">GAME OVER</div>
            <div class="subtitle">YOUR JOURNEY ENDS IN THE DEPTHS...</div>
            <div id="game-over-stats" style="margin-bottom: 20px; text-align: center; font-size: 8px;"></div>
            <button class="btn btn-primary" id="restart-btn">TRY AGAIN</button>
        </div>
    </div>

    <script>
        // =============================================
        // PIXEL ART GAME ENGINE - COMPLETAMENTE CORRIGIDO
        // =============================================
        
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        // Game state
        let gameState = 'menu';
        let player = {};
        let currentFloor = 1;
        let currentRoom = 13;
        let rooms = [];
        let enemies = [];
        let items = [];
        let projectiles = [];
        let particles = [];
        let combatTexts = [];
        let roomCleared = false;
        let visitedRooms = new Set();
        let stairsLocation = null;
        let merchantRoom = null;
        let npcs = [];

        // Sprites SIMPLES E FUNCIONAIS 8x8 pixels
        const sprites = {
            player: {
                body: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,2,2,2,1,0],
                    [0,1,2,3,3,2,1,0],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,1,1,1,0,0],
                    [0,1,0,1,1,0,1,0],
                    [0,1,0,1,1,0,1,0],
                    [0,0,1,0,0,1,0,0]
                ],
                colors: ['#000000', '#4a4a6a', '#6a6a8a']
            },

            skeleton: {
                body: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,2,2,2,1,0],
                    [0,1,2,3,3,2,1,0],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,1,1,1,0,0],
                    [0,0,1,0,0,1,0,0],
                    [0,1,0,1,1,0,1,0],
                    [1,0,0,0,0,0,0,1]
                ],
                colors: ['#000000', '#c0c0c0', '#ffffff']
            },

            zombie: {
                body: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,2,2,2,1,0],
                    [0,1,2,3,3,2,1,0],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,1,1,1,0,0],
                    [0,1,0,1,1,0,1,0],
                    [1,0,1,0,0,1,0,1],
                    [0,1,0,0,0,0,1,0]
                ],
                colors: ['#000000', '#2d5a27', '#3d6a37']
            },

            ghost: {
                body: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,2,2,2,1,0],
                    [1,2,3,2,2,3,2,1],
                    [1,2,2,2,2,2,2,1],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,2,2,1,0,0],
                    [0,0,0,1,1,0,0,0],
                    [0,0,0,0,0,0,0,0]
                ],
                colors: ['#000000', '#7b68ee', '#9b88ff']
            },

            mimic: {
                body: [
                    [1,1,1,1,1,1,1,1],
                    [1,2,2,3,3,2,2,1],
                    [1,2,3,2,2,3,2,1],
                    [1,2,2,2,2,2,2,1],
                    [1,2,2,2,2,2,2,1],
                    [1,2,2,2,2,2,2,1],
                    [1,2,2,2,2,2,2,1],
                    [1,1,1,1,1,1,1,1]
                ],
                colors: ['#000000', '#8b0000', '#daa520']
            },

            merchant: {
                body: [
                    [0,0,1,1,1,1,0,0],
                    [0,1,2,2,2,2,1,0],
                    [0,1,2,3,3,2,1,0],
                    [0,1,2,2,2,2,1,0],
                    [0,0,1,1,1,1,0,0],
                    [0,1,4,1,1,4,1,0],
                    [0,1,1,4,4,1,1,0],
                    [0,0,1,1,1,1,0,0]
                ],
                colors: ['#000000', '#32cd32', '#52ed52', '#daa520']
            },

            stairs: {
                body: [
                    [0,0,0,1,1,0,0,0],
                    [0,0,1,2,2,1,0,0],
                    [0,1,2,3,3,2,1,0],
                    [1,2,3,4,4,3,2,1],
                    [1,2,3,4,4,3,2,1],
                    [0,1,2,3,3,2,1,0],
                    [0,0,1,2,2,1,0,0],
                    [0,0,0,1,1,0,0,0]
                ],
                colors: ['#000000', '#daa520', '#fad560', '#ba8520']
            }
        };

        // Desenhar sprite CORRETAMENTE
        function drawSprite(spriteName, x, y, size = 32) {
            const sprite = sprites[spriteName];
            if (!sprite) return;
            
            const pixelSize = size / 8;
            const body = sprite.body;
            const colors = sprite.colors;
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const colorIndex = body[row][col];
                    if (colorIndex > 0) {
                        ctx.fillStyle = colors[colorIndex];
                        ctx.fillRect(
                            x + col * pixelSize - size/2,
                            y + row * pixelSize - size/2,
                            pixelSize,
                            pixelSize
                        );
                    }
                }
            }
        }

        // Tipos de armas com ataques diferentes
        const weaponTypes = [
            { 
                name: 'Iron Sword', 
                damage: [5, 8], 
                rarity: 'common', 
                type: 'weapon', 
                slot: 'weapon',
                attackType: 'melee'
            },
            { 
                name: 'Steel Bow', 
                damage: [4, 6], 
                rarity: 'uncommon', 
                type: 'weapon', 
                slot: 'weapon',
                attackType: 'ranged',
                projectileSpeed: 8
            },
            { 
                name: 'Magic Staff', 
                damage: [3, 5], 
                rarity: 'rare', 
                type: 'weapon', 
                slot: 'weapon',
                attackType: 'magic',
                projectileSpeed: 6,
                manaCost: 5
            }
        ];

        // Input handling
        const keys = {};
        const mouse = { x: 0, y: 0, down: false };
        
        // Game engine COMPLETAMENTE CORRIGIDA
        const game = {
            loop: function() {
                if (gameState !== 'playing') return;
                
                this.update();
                this.render();
                requestAnimationFrame(() => this.loop());
            },
            
            update: function() {
                this.updatePlayer();
                this.updateEnemies();
                this.updateProjectiles();
                this.updateCombatTexts();
                this.checkCollisions();
                this.updateUI();
                this.updateDoors();
                this.updateMiniMap();
            },

            updateDoors: function() {
                const directions = ['top', 'bottom', 'left', 'right'];
                directions.forEach(direction => {
                    const door = document.getElementById(`door-${direction}`);
                    if (this.hasDoor(direction)) {
                        door.style.display = 'block';
                    } else {
                        door.style.display = 'none';
                    }
                });
            },

            hasDoor: function(direction) {
                if (!rooms[currentRoom] || !rooms[currentRoom].doors) return false;
                return rooms[currentRoom].doors[direction];
            },

            changeRoom: function(direction) {
                let newRoom = currentRoom;
                switch(direction) {
                    case 'top': newRoom -= 5; break;
                    case 'bottom': newRoom += 5; break;
                    case 'left': newRoom -= 1; break;
                    case 'right': newRoom += 1; break;
                }

                if (newRoom >= 1 && newRoom <= 25) {
                    currentRoom = newRoom;
                    visitedRooms.add(currentRoom);
                    this.generateRoom();
                    this.positionPlayerFromDoor(direction);
                }
            },

            positionPlayerFromDoor: function(direction) {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                switch(direction) {
                    case 'top':
                        player.x = centerX;
                        player.y = canvas.height - 80;
                        break;
                    case 'bottom':
                        player.x = centerX;
                        player.y = 80;
                        break;
                    case 'left':
                        player.x = canvas.width - 80;
                        player.y = centerY;
                        break;
                    case 'right':
                        player.x = 80;
                        player.y = centerY;
                        break;
                }
            },

            updateMiniMap: function() {
                const miniMap = document.getElementById('mini-map');
                miniMap.innerHTML = '';
                
                for (let row = 0; row < 5; row++) {
                    for (let col = 0; col < 5; col++) {
                        const roomNumber = row * 5 + col + 1;
                        const roomElement = document.createElement('div');
                        roomElement.className = 'mini-map-room';
                        
                        if (roomNumber === currentRoom) {
                            roomElement.classList.add('current');
                            roomElement.textContent = 'â—';
                        } else if (visitedRooms.has(roomNumber)) {
                            roomElement.classList.add('visited');
                            
                            if (roomNumber === stairsLocation) {
                                roomElement.classList.add('stairs');
                                roomElement.textContent = 'â¤Š';
                            } else if (roomNumber === merchantRoom) {
                                roomElement.classList.add('merchant');
                                roomElement.textContent = 'ðŸ’°';
                            } else {
                                roomElement.textContent = 'â–ª';
                            }
                        }
                        
                        miniMap.appendChild(roomElement);
                    }
                }
            },
            
            render: function() {
                // Clear canvas
                ctx.fillStyle = '#0a0a0f';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                this.drawRoom();
                
                // Draw NPCs
                npcs.forEach(npc => {
                    drawSprite(npc.type, npc.x, npc.y, 32);
                });
                
                // Draw items
                items.forEach(item => {
                    if (item.type === 'chest' || item.type === 'mimic') {
                        drawSprite(item.type, item.x, item.y, 32);
                    } else {
                        ctx.fillStyle = item.color || '#daa520';
                        ctx.fillRect(item.x - 6, item.y - 6, 12, 12);
                    }
                });
                
                // Draw enemies
                enemies.forEach(enemy => {
                    drawSprite(enemy.type, enemy.x, enemy.y, 32);
                });
                
                // CORREÃ‡ÃƒO: Desenhar player CORRETAMENTE
                drawSprite('player', player.x, player.y, 32);
                
                // Draw projectiles
                projectiles.forEach(projectile => {
                    ctx.fillStyle = projectile.color;
                    ctx.beginPath();
                    ctx.arc(projectile.x, projectile.y, projectile.size, 0, Math.PI * 2);
                    ctx.fill();
                });

                // Draw combat texts
                combatTexts.forEach(text => {
                    ctx.fillStyle = text.color;
                    ctx.font = '12px Press Start 2P';
                    ctx.textAlign = 'center';
                    ctx.fillText(text.text, text.x, text.y);
                });
            },
            
            drawRoom: function() {
                // Room background
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(50, 50, canvas.width - 100, canvas.height - 100);
                
                // Room border
                ctx.strokeStyle = '#2d2d4d';
                ctx.lineWidth = 4;
                ctx.strokeRect(50, 50, canvas.width - 100, canvas.height - 100);
                
                // Simple torches
                ctx.fillStyle = '#8b0000';
                ctx.fillRect(70, 70, 4, 4);
                ctx.fillRect(canvas.width - 74, 70, 4, 4);
                ctx.fillRect(70, canvas.height - 74, 4, 4);
                ctx.fillRect(canvas.width - 74, canvas.height - 74, 4, 4);
            },
            
            updatePlayer: function() {
                let moveX = 0, moveY = 0;
                
                if (keys['w'] || keys['ArrowUp']) moveY -= player.speed;
                if (keys['s'] || keys['ArrowDown']) moveY += player.speed;
                if (keys['a'] || keys['ArrowLeft']) moveX -= player.speed;
                if (keys['d'] || keys['ArrowRight']) moveX += player.speed;
                
                // Update position with bounds checking
                const newX = player.x + moveX;
                const newY = player.y + moveY;
                
                if (newX >= 60 && newX <= canvas.width - 60) {
                    player.x = newX;
                }
                if (newY >= 60 && newY <= canvas.height - 60) {
                    player.y = newY;
                }
                
                // Update direction
                const dx = mouse.x - player.x;
                const dy = mouse.y - player.y;
                player.angle = Math.atan2(dy, dx);
                
                // Attack
                if (mouse.down && player.attackCooldown <= 0) {
                    this.playerAttack();
                    player.attackCooldown = player.attackSpeed;
                }
                
                if (player.attackCooldown > 0) {
                    player.attackCooldown--;
                }

                // Interactions
                if (keys['e']) {
                    this.checkInteractions();
                    keys['e'] = false;
                }

                // Regenerate mana
                if (player.mana < player.maxMana) {
                    player.mana += 0.05;
                    if (player.mana > player.maxMana) player.mana = player.maxMana;
                }
            },

            checkInteractions: function() {
                // Check stairs
                npcs.forEach(npc => {
                    if (npc.type === 'stairs') {
                        const dx = player.x - npc.x;
                        const dy = player.y - npc.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 40) {
                            this.nextFloor();
                            return;
                        }
                    }
                });

                // Check merchant
                npcs.forEach(npc => {
                    if (npc.type === 'merchant') {
                        const dx = player.x - npc.x;
                        const dy = player.y - npc.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 40) {
                            this.openMerchant();
                            return;
                        }
                    }
                });
            },

            openMerchant: function() {
                // Simple merchant interaction
                this.addCombatText('Merchant: Welcome!', player.x, player.y - 30, '#32cd32');
                player.gold += 50; // Give some gold for demo
                this.addCombatText('+50 Gold!', player.x, player.y - 50, '#daa520');
            },

            nextFloor: function() {
                currentFloor++;
                if (currentFloor > 5) {
                    this.gameOver();
                    return;
                }
                
                // CORREÃ‡ÃƒO: Reset completo ao mudar de andar
                player.health = player.maxHealth;
                player.mana = player.maxMana;
                
                // Generate new floor
                this.generateFloor();
                
                this.addCombatText(`Floor ${currentFloor}!`, player.x, player.y, '#00ff00');
            },
            
            playerAttack: function() {
                const weapon = player.equippedWeapon;
                const attackType = weapon ? weapon.attackType : 'melee';
                
                switch(attackType) {
                    case 'melee':
                        // Melee attack - damage enemies in range
                        enemies.forEach(enemy => {
                            const dx = enemy.x - player.x;
                            const dy = enemy.y - player.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            if (distance < 40) {
                                const damage = this.calculatePlayerDamage();
                                enemy.health -= damage;
                                this.addCombatText('-' + damage, enemy.x, enemy.y, '#ff0000');
                            }
                        });
                        break;
                        
                    case 'ranged':
                        // Ranged projectile
                        if (player.mana >= 3) {
                            player.mana -= 3;
                            const projectile = {
                                x: player.x,
                                y: player.y,
                                vx: Math.cos(player.angle) * 8,
                                vy: Math.sin(player.angle) * 8,
                                damage: this.calculatePlayerDamage(),
                                lifetime: 60,
                                size: 4,
                                color: '#c0c0c0'
                            };
                            projectiles.push(projectile);
                        }
                        break;
                        
                    case 'magic':
                        // Magic projectile
                        if (player.mana >= (weapon.manaCost || 5)) {
                            player.mana -= weapon.manaCost;
                            const projectile = {
                                x: player.x,
                                y: player.y,
                                vx: Math.cos(player.angle) * 6,
                                vy: Math.sin(player.angle) * 6,
                                damage: this.calculatePlayerDamage(),
                                lifetime: 90,
                                size: 6,
                                color: '#9370db'
                            };
                            projectiles.push(projectile);
                        }
                        break;
                }
            },
            
            updateEnemies: function() {
                enemies.forEach((enemy, index) => {
                    if (enemy.health <= 0) {
                        // Drop loot and gold
                        player.gold += enemy.goldReward;
                        player.exp += enemy.expReward;
                        
                        if (Math.random() < 0.3) {
                            this.spawnLoot(enemy.x, enemy.y);
                        }
                        
                        this.addCombatText('+' + enemy.goldReward + ' Gold', enemy.x, enemy.y, '#daa520');
                        enemies.splice(index, 1);
                        return;
                    }
                    
                    // Simple AI - move toward player
                    const dx = player.x - enemy.x;
                    const dy = player.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 200) {
                        enemy.x += (dx / distance) * enemy.speed;
                        enemy.y += (dy / distance) * enemy.speed;
                    }

                    // Enemy attack
                    if (distance < 30 && enemy.attackCooldown <= 0) {
                        player.health -= enemy.damage;
                        this.addCombatText('-' + enemy.damage, player.x, player.y, '#ff0000');
                        enemy.attackCooldown = enemy.attackSpeed;
                    }

                    if (enemy.attackCooldown > 0) {
                        enemy.attackCooldown--;
                    }
                });
            },
            
            updateProjectiles: function() {
                for (let i = projectiles.length - 1; i >= 0; i--) {
                    const projectile = projectiles[i];
                    projectile.x += projectile.vx;
                    projectile.y += projectile.vy;
                    projectile.lifetime--;
                    
                    if (projectile.lifetime <= 0 || 
                        projectile.x < 50 || projectile.x > canvas.width - 50 ||
                        projectile.y < 50 || projectile.y > canvas.height - 50) {
                        projectiles.splice(i, 1);
                    }
                }
            },

            updateCombatTexts: function() {
                for (let i = combatTexts.length - 1; i >= 0; i--) {
                    const text = combatTexts[i];
                    text.y -= 1;
                    text.life--;
                    
                    if (text.life <= 0) {
                        combatTexts.splice(i, 1);
                    }
                }
            },

            addCombatText: function(text, x, y, color) {
                combatTexts.push({
                    text: text,
                    x: x,
                    y: y,
                    color: color,
                    life: 60
                });
            },
            
            checkCollisions: function() {
                // Projectile vs Enemy
                for (let i = projectiles.length - 1; i >= 0; i--) {
                    for (let j = enemies.length - 1; j >= 0; j--) {
                        const dx = projectiles[i].x - enemies[j].x;
                        const dy = projectiles[i].y - enemies[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 20) {
                            enemies[j].health -= projectiles[i].damage;
                            this.addCombatText('-' + projectiles[i].damage, enemies[j].x, enemies[j].y, '#ff0000');
                            projectiles.splice(i, 1);
                            break;
                        }
                    }
                }
                
                // Player vs Items
                for (let i = items.length - 1; i >= 0; i--) {
                    const dx = player.x - items[i].x;
                    const dy = player.y - items[i].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 25) {
                        this.collectItem(items[i]);
                        items.splice(i, 1);
                    }
                }

                // Check player death
                if (player.health <= 0) {
                    this.gameOver();
                }
            },
            
            collectItem: function(item) {
                if (item.type === 'chest') {
                    for (let i = 0; i < 3; i++) {
                        this.spawnRandomItem(item.x, item.y);
                    }
                    this.addCombatText('Chest Opened!', item.x, item.y, '#daa520');
                } else if (item.type === 'mimic') {
                    enemies.push(this.createEnemy('mimic', item.x, item.y));
                    this.addCombatText('Mimic!', item.x, item.y, '#ff0000');
                } else {
                    this.addToInventory(item);
                    this.addCombatText(item.name + '!', item.x, item.y, '#00ff00');
                }
            },
            
            spawnLoot: function(x, y) {
                const lootTypes = ['weapon', 'armor', 'potion'];
                const lootType = lootTypes[Math.floor(Math.random() * lootTypes.length)];
                this.spawnRandomItem(x, y, lootType);
            },
            
            spawnRandomItem: function(x, y, type = null) {
                if (!type) {
                    const types = ['weapon', 'armor', 'potion', 'chest', 'mimic'];
                    type = types[Math.floor(Math.random() * types.length)];
                }
                
                let item;
                
                if (type === 'weapon') {
                    const weapons = [
                        { name: 'Iron Sword', damage: [5, 8], rarity: 'common', attackType: 'melee' },
                        { name: 'Steel Bow', damage: [4, 6], rarity: 'uncommon', attackType: 'ranged' },
                        { name: 'Magic Staff', damage: [3, 5], rarity: 'rare', attackType: 'magic', manaCost: 5 }
                    ];
                    item = {...weapons[Math.floor(Math.random() * weapons.length)]};
                    item.type = 'weapon';
                } else if (type === 'potion') {
                    item = {
                        type: 'potion',
                        name: 'Health Potion',
                        health: 30,
                        color: '#ff0000'
                    };
                } else {
                    item = {
                        type: type,
                        name: type.charAt(0).toUpperCase() + type.slice(1),
                        color: '#daa520'
                    };
                }
                
                item.x = x;
                item.y = y;
                item.rarity = item.rarity || 'common';
                items.push(item);
            },

            getRarityColor: function(rarity) {
                switch(rarity) {
                    case 'common': return '#969696';
                    case 'uncommon': return '#2ecc71';
                    case 'rare': return '#3498db';
                    case 'epic': return '#9b59b6';
                    case 'legendary': return '#f1c40f';
                    default: return '#daa520';
                }
            },
            
            createEnemy: function(type, x, y) {
                const baseStats = {
                    skeleton: { health: 30, damage: 5, speed: 1.5, goldReward: 10, expReward: 15 },
                    zombie: { health: 40, damage: 7, speed: 1, goldReward: 15, expReward: 20 },
                    ghost: { health: 25, damage: 6, speed: 2, goldReward: 12, expReward: 18 },
                    mimic: { health: 50, damage: 10, speed: 1.2, goldReward: 25, expReward: 30 }
                };
                
                const stats = baseStats[type];
                const floorMultiplier = 1 + (currentFloor - 1) * 0.5;
                
                return {
                    type: type,
                    x: x || Math.random() * (canvas.width - 100) + 50,
                    y: y || Math.random() * (canvas.height - 100) + 50,
                    health: Math.floor(stats.health * floorMultiplier),
                    maxHealth: Math.floor(stats.health * floorMultiplier),
                    damage: Math.floor(stats.damage * floorMultiplier),
                    speed: stats.speed,
                    goldReward: Math.floor(stats.goldReward * floorMultiplier),
                    expReward: Math.floor(stats.expReward * floorMultiplier),
                    attackCooldown: 0,
                    attackSpeed: 60
                };
            },

            generateFloor: function() {
                rooms = [];
                visitedRooms = new Set([13]);
                currentRoom = 13;
                
                // Generate random special rooms
                const specialRooms = this.generateSpecialRooms();
                stairsLocation = specialRooms.stairs;
                merchantRoom = specialRooms.merchant;
                
                // Create 5x5 grid
                for (let i = 1; i <= 25; i++) {
                    let roomType = 'normal';
                    if (i === 13) roomType = 'start';
                    else if (i === stairsLocation) roomType = 'stairs';
                    else if (i === merchantRoom) roomType = 'merchant';
                    
                    rooms[i] = {
                        type: roomType,
                        doors: this.generateDoors(i),
                        cleared: i === 13
                    };
                }
                
                this.generateRoom();
            },

            generateSpecialRooms: function() {
                const availableRooms = [];
                for (let i = 1; i <= 25; i++) {
                    if (i !== 13) availableRooms.push(i);
                }
                
                // Shuffle and pick special rooms
                for (let i = availableRooms.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [availableRooms[i], availableRooms[j]] = [availableRooms[j], availableRooms[i]];
                }
                
                return {
                    stairs: availableRooms[0],
                    merchant: availableRooms[1]
                };
            },

            generateDoors: function(roomNumber) {
                const row = Math.floor((roomNumber - 1) / 5);
                const col = (roomNumber - 1) % 5;
                
                return {
                    top: row > 0,
                    bottom: row < 4,
                    left: col > 0,
                    right: col < 4
                };
            },

            generateRoom: function() {
                enemies = [];
                items = [];
                npcs = [];
                projectiles = [];
                combatTexts = [];
                
                const room = rooms[currentRoom];
                
                // Add content based on room type
                switch(room.type) {
                    case 'start':
                        // Safe starting room - maybe a healing fountain?
                        break;
                    case 'stairs':
                        npcs.push({
                            type: 'stairs',
                            x: canvas.width / 2,
                            y: canvas.height / 2
                        });
                        break;
                    case 'merchant':
                        npcs.push({
                            type: 'merchant',
                            x: canvas.width / 2,
                            y: canvas.height / 2
                        });
                        break;
                    default:
                        // Normal room with enemies and loot
                        const enemyCount = 2 + Math.floor(Math.random() * 3) + currentFloor;
                        for (let i = 0; i < enemyCount; i++) {
                            const enemyTypes = ['skeleton', 'zombie', 'ghost'];
                            const enemyType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                            enemies.push(this.createEnemy(enemyType));
                        }
                        
                        // Chance for chest
                        if (Math.random() < 0.4) {
                            items.push({
                                type: Math.random() < 0.1 ? 'mimic' : 'chest',
                                x: Math.random() * (canvas.width - 100) + 50,
                                y: Math.random() * (canvas.height - 100) + 50
                            });
                        }

                        // Chance for random loot
                        if (Math.random() < 0.3) {
                            this.spawnRandomItem(
                                Math.random() * (canvas.width - 100) + 50,
                                Math.random() * (canvas.height - 100) + 50
                            );
                        }
                }
            },
            
            calculatePlayerDamage: function() {
                let damage = player.damageMin + Math.random() * (player.damageMax - player.damageMin);
                if (player.equippedWeapon) {
                    damage += player.equippedWeapon.damage[0] + 
                             Math.random() * (player.equippedWeapon.damage[1] - player.equippedWeapon.damage[0]);
                }
                return Math.floor(damage);
            },
            
            addToInventory: function(item) {
                if (player.inventory.length < 16) {
                    player.inventory.push(item);
                    
                    if (item.type === 'potion') {
                        player.health = Math.min(player.maxHealth, player.health + item.health);
                        this.addCombatText('+' + item.health + ' HP', player.x, player.y, '#00ff00');
                    }
                    
                    this.updateInventoryUI();
                }
            },
            
            updateInventoryUI: function() {
                const inventorySlots = document.getElementById('inventory-slots');
                inventorySlots.innerHTML = '';
                
                player.inventory.forEach((item, index) => {
                    const slot = document.createElement('div');
                    slot.className = 'inventory-slot';
                    slot.textContent = item.name.charAt(0);
                    slot.title = `${item.name} (${item.rarity || 'common'})`;
                    slot.style.borderLeftColor = this.getRarityColor(item.rarity);
                    
                    slot.addEventListener('click', (e) => {
                        if (e.altKey) {
                            player.inventory.splice(index, 1);
                            this.updateInventoryUI();
                        } else {
                            this.equipItem(index);
                        }
                    });
                    
                    inventorySlots.appendChild(slot);
                });
                
                for (let i = player.inventory.length; i < 16; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'inventory-slot';
                    inventorySlots.appendChild(slot);
                }
            },
            
            equipItem: function(index) {
                const item = player.inventory[index];
                if (item.type === 'weapon') {
                    if (player.equippedWeapon) {
                        player.inventory.push(player.equippedWeapon);
                    }
                    player.equippedWeapon = item;
                    player.inventory.splice(index, 1);
                    
                    this.updatePlayerStats();
                    this.updateInventoryUI();
                    this.updateEquipmentUI();
                    this.addCombatText('Equipped: ' + item.name, player.x, player.y, '#daa520');
                }
            },
            
            updatePlayerStats: function() {
                // Update player stats based on equipment
                if (player.equippedWeapon) {
                    player.damageMin = 8 + player.equippedWeapon.damage[0];
                    player.damageMax = 12 + player.equippedWeapon.damage[1];
                } else {
                    player.damageMin = 8;
                    player.damageMax = 12;
                }
            },
            
            updateEquipmentUI: function() {
                document.getElementById('equipped-weapon').textContent = 
                    player.equippedWeapon ? player.equippedWeapon.name : '-';
            },
            
            updateUI: function() {
                document.getElementById('health-fill').style.width = (player.health / player.maxHealth * 100) + '%';
                document.getElementById('mana-fill').style.width = (player.mana / player.maxMana * 100) + '%';
                document.getElementById('player-level').textContent = player.level;
                document.getElementById('player-damage').textContent = player.damageMin + '-' + player.damageMax;
                document.getElementById('player-defense').textContent = player.defense;
                document.getElementById('player-gold').textContent = player.gold;
                document.getElementById('floor-number').textContent = currentFloor;
                document.getElementById('room-number').textContent = currentRoom;
            },

            gameOver: function() {
                gameState = 'gameOver';
                document.querySelector('.game-over').style.display = 'flex';
                document.getElementById('game-over-stats').innerHTML = `
                    <div>Reached Level: ${player.level}</div>
                    <div>Floor: ${currentFloor}</div>
                    <div>Gold: ${player.gold}</div>
                    <div>Total Kills: ${player.totalKills || 0}</div>
                `;
            },
            
            initGame: function() {
                // CORREÃ‡ÃƒO: InicializaÃ§Ã£o completa e correta
                player = {
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    speed: 4,
                    health: 100,
                    maxHealth: 100,
                    mana: 100,
                    maxMana: 100,
                    damageMin: 8,
                    damageMax: 12,
                    defense: 5,
                    level: 1,
                    gold: 50,
                    exp: 0,
                    expToNextLevel: 100,
                    attackCooldown: 0,
                    attackSpeed: 20,
                    inventory: [],
                    equippedWeapon: null,
                    totalKills: 0
                };
                
                currentFloor = 1;
                currentRoom = 13;
                visitedRooms = new Set([13]);
                
                this.generateFloor();
                this.updateInventoryUI();
                this.updateEquipmentUI();
                this.loop();
            }
        };

        // Event Listeners
        window.addEventListener('load', function() {
            // Mouse events
            canvas.addEventListener('mousemove', function(e) {
                const rect = canvas.getBoundingClientRect();
                mouse.x = (e.clientX - rect.left) * (canvas.width / rect.width);
                mouse.y = (e.clientY - rect.top) * (canvas.height / rect.height);
            });
            
            canvas.addEventListener('mousedown', function() {
                mouse.down = true;
            });
            
            canvas.addEventListener('mouseup', function() {
                mouse.down = false;
            });
            
            // Keyboard events
            window.addEventListener('keydown', function(e) {
                keys[e.key] = true;
            });
            
            window.addEventListener('keyup', function(e) {
                keys[e.key] = false;
            });
            
            // Door events
            document.querySelectorAll('.door').forEach(door => {
                door.addEventListener('click', function() {
                    const direction = this.dataset.direction;
                    game.changeRoom(direction);
                });
            });
            
            // UI events
            document.getElementById('start-btn').addEventListener('click', function() {
                document.querySelector('.start-screen').style.display = 'none';
                gameState = 'playing';
                game.initGame();
            });
            
            document.getElementById('restart-btn').addEventListener('click', function() {
                document.querySelector('.game-over').style.display = 'none';
                gameState = 'playing';
                game.initGame();
            });
            
            // Create initial inventory slots
            const inventorySlots = document.getElementById('inventory-slots');
            for (let i = 0; i < 16; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                inventorySlots.appendChild(slot);
            }
        });
    </script>
</body>
</html>
